<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>BrokerSign â€“ ×—×ª×™××” ×¢×œ ××¡××š</title>
<link href="https://fonts.googleapis.com/css2?family=Heebo:wght@300;400;500;600;700;800&family=Playfair+Display:wght@700&display=swap" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<style>
:root{--ink:#0f0e0d;--paper:#f7f4ef;--warm:#faf8f4;--gold:#c9a84c;--deep:#1a1714;--mid:#6b6560;--border:#ddd8cf;--success:#2d6a4f}
*{margin:0;padding:0;box-sizing:border-box}
body{font-family:'Heebo',sans-serif;background:var(--paper);color:var(--ink);direction:rtl;min-height:100vh}
.header{background:var(--deep);padding:16px 24px;display:flex;align-items:center;justify-content:space-between}
.header .brand{font-family:'Playfair Display',serif;font-size:20px;color:var(--gold)}
.header .secure{font-size:12px;color:rgba(255,255,255,0.5)}
.container{max-width:720px;margin:0 auto;padding:28px 20px}
.card{background:var(--warm);border:1px solid var(--border);border-radius:16px;padding:28px;margin-bottom:20px}
.card h2{font-size:18px;font-weight:800;margin-bottom:6px}
.card .sub{font-size:13px;color:var(--mid);margin-bottom:20px}
.contract{font-size:14px;line-height:2;color:#1a1a1a}
.contract-title{text-align:center;font-size:20px;font-weight:900;margin-bottom:6px;letter-spacing:1px}
.contract-sub{text-align:center;font-size:13px;color:var(--mid);margin-bottom:24px;padding-bottom:20px;border-bottom:2px solid var(--ink)}
.contract-section{margin-bottom:20px}
.contract-section-title{font-size:15px;font-weight:800;margin-bottom:10px;color:var(--deep);border-right:3px solid var(--gold);padding-right:10px}
.contract-parties{background:#fff;border:1px solid var(--border);border-radius:10px;padding:16px;margin-bottom:12px}
.party-row{display:grid;grid-template-columns:120px 1fr;gap:8px;padding:6px 0;border-bottom:1px solid rgba(0,0,0,0.06);font-size:13px}
.party-row:last-child{border-bottom:none}
.party-label{color:var(--mid);font-weight:600}
.party-value{font-weight:700}
.contract-clause{margin-bottom:12px;padding-right:16px;position:relative;line-height:1.8;font-size:13.5px}
.contract-clause::before{content:counter(clause-counter);counter-increment:clause-counter;position:absolute;right:0;font-weight:800;color:var(--gold);font-size:12px;top:3px}
.contract-body{counter-reset:clause-counter}
.contract-highlight{background:rgba(201,168,76,0.1);border:1px solid rgba(201,168,76,0.3);border-radius:6px;padding:10px 14px;margin:12px 0;font-weight:600;font-size:13px}
.contract-footer{margin-top:24px;padding-top:20px;border-top:2px solid var(--ink);text-align:center;font-size:12px;color:var(--mid)}
.sig-label{font-size:13px;font-weight:600;margin-bottom:8px;display:block}
.sig-area{border:2px dashed var(--border);border-radius:10px;background:#fff;height:160px;position:relative;overflow:hidden;cursor:crosshair;margin-bottom:10px;touch-action:none}
.sig-area canvas{position:absolute;inset:0}
.sig-placeholder{position:absolute;inset:0;display:flex;align-items:center;justify-content:center;color:var(--mid);font-size:14px;pointer-events:none}
.form-group{margin-bottom:16px}
.form-label{display:block;font-size:13px;font-weight:600;margin-bottom:6px}
.form-input{width:100%;padding:11px 14px;border:1.5px solid var(--border);border-radius:8px;font-family:'Heebo',sans-serif;font-size:14px;background:#fff;direction:rtl}
.form-input:focus{outline:none;border-color:var(--gold)}
.checkbox-wrap{display:flex;gap:10px;align-items:flex-start;margin-bottom:20px}
.checkbox-wrap input{width:18px;height:18px;margin-top:2px;flex-shrink:0}
.checkbox-wrap label{font-size:13px;line-height:1.6;color:var(--mid)}
.btn{width:100%;padding:14px;border-radius:10px;font-family:'Heebo',sans-serif;font-size:16px;font-weight:700;cursor:pointer;border:none;transition:all 0.2s}
.btn-primary{background:var(--gold);color:var(--deep)}
.btn-primary:hover{background:#e8d08a}
.btn-primary:disabled{background:var(--border);color:var(--mid);cursor:not-allowed}
.btn-ghost{background:transparent;color:var(--mid);font-size:13px;margin-top:10px}
.success-screen{text-align:center;padding:60px 20px}
.success-screen .check{font-size:72px;margin-bottom:20px}
.success-screen h2{font-size:24px;font-weight:800;margin-bottom:10px}
.success-screen p{color:var(--mid);font-size:15px;line-height:1.7}
.success-details{background:rgba(45,106,79,0.08);border:1px solid rgba(45,106,79,0.2);border-radius:10px;padding:16px;margin:20px 0;text-align:right;font-size:13px}
.success-details strong{display:block;margin-bottom:8px;color:var(--success);font-size:14px}
.error-screen,.loading-screen{text-align:center;padding:80px 20px}
.spinner{width:40px;height:40px;border:3px solid var(--border);border-top-color:var(--gold);border-radius:50%;animation:spin 0.8s linear infinite;margin:0 auto 16px}
@keyframes spin{to{transform:rotate(360deg)}}
.step{display:none}
.step.active{display:block}
.download-btn{display:inline-flex;align-items:center;gap:8px;background:var(--deep);color:#fff;padding:12px 24px;border-radius:8px;font-family:'Heebo',sans-serif;font-size:14px;font-weight:600;cursor:pointer;border:none;margin-top:16px}
@media(max-width:480px){.container{padding:16px}.card{padding:18px}.party-row{grid-template-columns:100px 1fr}}
</style>
</head>
<body>
<div class="header">
  <div class="brand">BrokerSign</div>
  <div class="secure">ğŸ”’ ×—×ª×™××” ×××•×‘×˜×—×ª</div>
</div>
<div class="container">
  <div id="loading-screen" class="loading-screen">
    <div class="spinner"></div>
    <p>×˜×•×¢×Ÿ ××ª ×”××¡××š ×©×œ×š...</p>
  </div>
  <div id="error-screen" class="error-screen" style="display:none">
    <div style="font-size:64px;margin-bottom:20px">âš ï¸</div>
    <h2 style="font-size:22px;font-weight:800;margin-bottom:10px">×”××¡××š ×œ× × ××¦×</h2>
    <p style="color:var(--mid)">×”×§×™×©×•×¨ ×©×’×•×™, ×¤×’ ×ª×•×§×¤×•, ××• ×©×”××¡××š ×›×‘×¨ × ×—×ª×.</p>
  </div>
  <div id="success-screen" class="success-screen" style="display:none">
    <div class="check">âœ…</div>
    <h2>×”×—×ª×™××” ×”×ª×§×‘×œ×” ×‘×”×¦×œ×—×”!</h2>
    <p>×¢×•×ª×§ ×”××¡××š ×”×—×ª×•× × ×©×œ×— ×œ××™×™×œ ×©×œ×š ×•×œ××ª×•×•×š.</p>
    <div class="success-details">
      <strong>âœï¸ ×¤×¨×˜×™ ×”×—×ª×™××”:</strong>
      <span id="success-name"></span><br>
      <span id="success-date"></span>
    </div>
    <button class="download-btn" onclick="downloadPDF()">ğŸ“„ ×”×•×¨×“ ××¡××š PDF ×—×ª×•×</button>
  </div>
  <div id="main-content" style="display:none">
    <div id="step1" class="step active">
      <div class="card">
        <div class="contract" id="contract-content"></div>
      </div>
      <button class="btn btn-primary" onclick="goToStep(2)">×§×¨××ª×™ ××ª ×”××¡××š ×•××•×›×Ÿ/×” ×œ×—×ª×•× â†</button>
    </div>
    <div id="step2" class="step">
      <div class="card">
        <h2>âœï¸ ×—×ª×™××” ×“×™×’×™×˜×œ×™×ª</h2>
        <div class="sub">×—×ª×•×/×™ ×‘×ª×™×‘×” ×œ××˜×” ×‘××¦×‘×¢</div>
        <span class="sig-label">×—×ª×™××ª×š:</span>
        <div class="sig-area" id="sig-area">
          <canvas id="sig-canvas"></canvas>
          <div class="sig-placeholder" id="sig-ph">×—×ª×•×/×™ ×›××Ÿ ×‘××¦×‘×¢</div>
        </div>
        <button class="btn btn-ghost" onclick="clearSig()" style="width:auto;padding:6px 16px;font-size:12px;margin-bottom:20px">ğŸ—‘ × ×§×”</button>
        <div class="form-group">
          <label class="form-label">×©× ××œ× ×œ××™×©×•×¨ *</label>
          <input class="form-input" id="signer-name" placeholder="×”×›× ×¡/×™ ×©××š ×”××œ×">
        </div>
        <div class="checkbox-wrap">
          <input type="checkbox" id="agree-check">
          <label for="agree-check">×× ×™ ×××©×¨/×ª ×›×™ ×§×¨××ª×™ ××ª ×”××¡××š, ×”×‘× ×ª×™ ××ª ×ª×•×›× ×• ×•××ª ×”×ª×—×™×™×‘×•×™×•×ª×™×™, ×•×—×ª×™××ª×™ ×”×“×™×’×™×˜×œ×™×ª ××—×™×™×‘×ª ××•×ª×™ ×œ×›×œ ×“×‘×¨ ×•×¢× ×™×™×Ÿ ×›×—×ª×™××” ×‘×›×ª×‘ ×××©.</label>
        </div>
        <button class="btn btn-primary" id="submit-btn" onclick="submitSignature()" disabled>âœ… ×× ×™ ×—×•×ª×/×ª ×•×××©×¨/×ª ××ª ×”××¡××š</button>
        <button class="btn btn-ghost" onclick="goToStep(1)">â†’ ×—×–×•×¨ ×œ×§×¨×™××ª ×”××¡××š</button>
      </div>
    </div>
  </div>
</div>
<script>
const SUPABASE_URL='https://lrelmsldoqkifmxionnk.supabase.co';
const SUPABASE_KEY='sb_publishable_Z9haU6VnacVW52WoW_Qtsw_bZp9Rs9_';
const RESEND_KEY='re_f4oCuD6M_5gWBBocPRC4zsZeyJLLtG2gM';
const {createClient}=supabase;
const sb=createClient(SUPABASE_URL,SUPABASE_KEY);
let docData=null,brokerData=null,sigCanvas,sigCtx,signing=false,hasSig=false,signedAt=null,signerNameFinal='';
const typeNames={exclusivity:'×”×¡×›× ×‘×œ×¢×“×™×•×ª',management:'×”×¡×›× × ×™×”×•×œ × ×›×¡',memorandum:'×–×™×›×¨×•×Ÿ ×“×‘×¨×™×',poa:'×™×™×¤×•×™ ×›×•×—',buyer_agency:'×”×¡×›× ×ª×™×•×•×š â€“ ×œ×§×•×— ×§×•× ×”'};

async function init(){
  const token=new URLSearchParams(window.location.search).get('token');
  if(!token){showError();return;}
  const{data,error}=await sb.from('documents').select('*').eq('signing_token',token).single();
  if(error||!data){showError();return;}
  if(data.status==='signed'){showError('×”××¡××š ×›×‘×¨ × ×—×ª×');return;}
  docData=data;
  const{data:broker}=await sb.from('brokers').select('*').eq('id',data.broker_id).single();
  brokerData=broker;
  renderContract();
  document.getElementById('loading-screen').style.display='none';
  document.getElementById('main-content').style.display='block';
  setTimeout(initSig,100);
}

function renderContract(){
  const c=docData.content||{};
  const clientName=c.client_name||docData.title||'â€”';
  const clientId=c.client_id||'â€”';
  const clientPhone=c.client_phone||'â€”';
  const clientEmail=c.client_email||'â€”';
  const property=docData.notes||'â€”';
  const fee=docData.fee_percent||'â€”';
  const startDate=docData.start_date?new Date(docData.start_date).toLocaleDateString('he-IL'):new Date().toLocaleDateString('he-IL');
  const expireDate=docData.expire_date?new Date(docData.expire_date).toLocaleDateString('he-IL'):'â€”';
  const today=new Date().toLocaleDateString('he-IL');
  const brokerName=brokerData?.full_name||'â€”';
  const brokerPhone=brokerData?.phone||'â€”';
  const brokerEmail=brokerData?.email||'â€”';
  const brokerCompany=brokerData?.company_name||'';
  const docType=docData.document_type;
  document.title=`BrokerSign â€“ ${typeNames[docType]}`;

  let html='';
  if(docType==='exclusivity'||!docType){
    html=`
    <div class="contract-title">×”×¡×›× ×‘×œ×¢×“×™×•×ª ×‘×ª×™×•×•×š</div>
    <div class="contract-sub">×”×¡×›× ×–×” × ×¢×¨×š ×•× ×—×ª× ×‘×™×•× ${today}</div>
    <div class="contract-section">
      <div class="contract-section-title">×”×¦×“×“×™× ×œ×”×¡×›×</div>
      <div class="contract-parties">
        <div style="font-weight:700;font-size:13px;margin-bottom:10px;color:var(--mid)">×”××ª×•×•×š:</div>
        <div class="party-row"><div class="party-label">×©×:</div><div class="party-value">${brokerName}${brokerCompany?' | '+brokerCompany:''}</div></div>
        <div class="party-row"><div class="party-label">×˜×œ×¤×•×Ÿ:</div><div class="party-value">${brokerPhone}</div></div>
        <div class="party-row"><div class="party-label">××™××™×™×œ:</div><div class="party-value">${brokerEmail}</div></div>
      </div>
      <div class="contract-parties">
        <div style="font-weight:700;font-size:13px;margin-bottom:10px;color:var(--mid)">×‘×¢×œ ×”× ×›×¡:</div>
        <div class="party-row"><div class="party-label">×©× ××œ×:</div><div class="party-value">${clientName}</div></div>
        <div class="party-row"><div class="party-label">×ª.×–.:</div><div class="party-value">${clientId}</div></div>
        <div class="party-row"><div class="party-label">×˜×œ×¤×•×Ÿ:</div><div class="party-value">${clientPhone}</div></div>
        <div class="party-row"><div class="party-label">××™××™×™×œ:</div><div class="party-value">${clientEmail}</div></div>
      </div>
      <div class="contract-parties">
        <div style="font-weight:700;font-size:13px;margin-bottom:10px;color:var(--mid)">×¤×¨×˜×™ ×”× ×›×¡:</div>
        <div class="party-row"><div class="party-label">×›×ª×•×‘×ª:</div><div class="party-value">${property}</div></div>
        <div class="party-row"><div class="party-label">×ª×§×•×¤×ª ×‘×œ×¢×“×™×•×ª:</div><div class="party-value">${startDate} ×¢×“ ${expireDate}</div></div>
        <div class="party-row"><div class="party-label">×“××™ ×ª×™×•×•×š:</div><div class="party-value">${fee}</div></div>
      </div>
    </div>
    <div class="contract-section">
      <div class="contract-section-title">×ª× ××™ ×”×”×¡×›×</div>
      <div class="contract-body">
        <div class="contract-clause">×‘×¢×œ ×”× ×›×¡ ××¡××™×š ×‘×–××ª ××ª ×”××ª×•×•×š, ×‘×œ×¢×“×™×ª ×•×‘××•×¤×Ÿ ×™×™×—×•×“×™, ×œ×©×•×•×§, ×œ×¤×¨×¡× ×•×œ×ª×•×•×š ×‘××›×™×¨×” / ×”×©×›×¨×ª ×”× ×›×¡ ×”× "×œ, ×‘×ª×§×•×¤×ª ×”×‘×œ×¢×“×™×•×ª ×”× ×§×•×‘×” ×œ×¢×™×œ.</div>
        <div class="contract-clause">×‘×ª×§×•×¤×ª ×”×‘×œ×¢×“×™×•×ª, ×‘×¢×œ ×”× ×›×¡ ××ª×—×™×™×‘ ×©×œ× ×œ×”×ª×§×©×¨ ×¢× ××ª×•×•×š ××—×¨ ×•×œ× ×œ× ×”×œ ××•"× ×™×©×™×¨ ×¢× ×§×•× ×™× / ×©×•×›×¨×™× ×©×œ× ×”×’×™×¢×• ×“×¨×š ×”××ª×•×•×š, ××œ× ×‘×”×¡×›××” ×›×ª×•×‘×” ××¤×•×¨×©×ª.</div>
        <div class="contract-clause">×‘×’×™×Ÿ ×›×œ ×¢×¡×§×” ×©×ª×•×©×œ× ×‘×ª×§×•×¤×ª ×”×‘×œ×¢×“×™×•×ª â€“ ×‘×™×Ÿ ×× ×‘×××¦×¢×•×ª ×”××ª×•×•×š ×•×‘×™×Ÿ ×× ×œ××• â€“ ×™×—×•×™×‘ ×‘×¢×œ ×”× ×›×¡ ×‘×“××™ ×ª×™×•×•×š ×‘×©×™×¢×•×¨ ×©×œ <strong>${fee}</strong> ×××—×™×¨ ×”×¢×¡×§×”, ×‘×ª×•×¡×¤×ª ××¢"× ×›×“×™×Ÿ.</div>
        <div class="contract-clause">×”××ª×•×•×š ××ª×—×™×™×‘ ×œ×¤×¢×•×œ ×‘××™×˜×‘ ×™×›×•×œ×ª×• ×œ×©×™×•×•×§ ×”× ×›×¡, ×œ×¨×‘×•×ª ×¤×¨×¡×•×, ×”×‘××ª ×§×•× ×™× / ×©×•×›×¨×™× ×¤×•×˜× ×¦×™××œ×™×™×, × ×™×”×•×œ ××•"× ×•×¡×™×•×¢ ×‘×”×©×œ××ª ×”×¢×¡×§×”.</div>
        <div class="contract-clause">×“××™ ×”×ª×™×•×•×š ×™×©×•×œ××• ×¢× ×—×ª×™××ª ×”×¡×›× ×”××›×¨ / ×©×›×™×¨×•×ª ×”××—×™×™×‘, ××• ×œ×¤×™ ×”×¡×›××” ××—×¨×ª ×‘×›×ª×‘ ×‘×™×Ÿ ×”×¦×“×“×™×.</div>
        <div class="contract-clause">×”×¤×¨×ª ×ª× ××™ ×”×¡×›× ×–×” ×¢×œ ×™×“×™ ×‘×¢×œ ×”× ×›×¡ ×ª×§× ×” ×œ××ª×•×•×š ×–×›×•×ª ×œ×¤×™×¦×•×™×™× ×‘×’×•×‘×” ×“××™ ×”×ª×™×•×•×š ×”××•×¡×›××™×, ×œ×œ× ×ª×œ×•×ª ×‘×”×©×œ××ª ×¢×¡×§×” ×‘×¤×•×¢×œ.</div>
        <div class="contract-clause">×”×¡×›× ×–×” × ×¢×¨×š ×‘×”×ª×× ×œ×—×•×§ ×”××ª×•×•×›×™× ×‘××§×¨×§×¢×™×Ÿ, ×ª×©× "×•-1996 ×•×›×œ ×“×™×Ÿ ×¨×œ×•×•× ×˜×™ ××—×¨.</div>
      </div>
    </div>
    <div class="contract-highlight">âš–ï¸ ×—×ª×™××” ×¢×œ ××¡××š ×–×” ××”×•×•×” ×”×¡×›××” ××œ××” ×•××—×™×™×‘×ª ×œ×›×œ ×”×ª× ××™× ×”× ×§×•×‘×™× ×œ×¢×™×œ, ×œ×¨×‘×•×ª ×ª×©×œ×•× ×“××™ ×ª×™×•×•×š.</div>
    <div class="contract-footer">××¡××š ×–×” × ×—×ª× ×“×™×’×™×˜×œ×™×ª ×“×¨×š ××¢×¨×›×ª BrokerSign | brokersign-rho.vercel.app</div>`;
  } else if(docType==='buyer_agency'){
    html=`
    <div class="contract-title">×”×¡×›× ×ª×™×•×•×š â€“ ×œ×§×•×— ×§×•× ×”</div>
    <div class="contract-sub">×”×¡×›× ×–×” × ×¢×¨×š ×•× ×—×ª× ×‘×™×•× ${today}</div>
    <div class="contract-section">
      <div class="contract-section-title">×”×¦×“×“×™× ×œ×”×¡×›×</div>
      <div class="contract-parties">
        <div style="font-weight:700;font-size:13px;margin-bottom:10px;color:var(--mid)">×”××ª×•×•×š:</div>
        <div class="party-row"><div class="party-label">×©×:</div><div class="party-value">${brokerName}${brokerCompany?' | '+brokerCompany:''}</div></div>
        <div class="party-row"><div class="party-label">×˜×œ×¤×•×Ÿ:</div><div class="party-value">${brokerPhone}</div></div>
      </div>
      <div class="contract-parties">
        <div style="font-weight:700;font-size:13px;margin-bottom:10px;color:var(--mid)">×”×§×•× ×”:</div>
        <div class="party-row"><div class="party-label">×©× ××œ×:</div><div class="party-value">${clientName}</div></div>
        <div class="party-row"><div class="party-label">×ª.×–.:</div><div class="party-value">${clientId}</div></div>
        <div class="party-row"><div class="party-label">×˜×œ×¤×•×Ÿ:</div><div class="party-value">${clientPhone}</div></div>
        <div class="party-row"><div class="party-label">×“××™ ×ª×™×•×•×š:</div><div class="party-value">${fee}</div></div>
        <div class="party-row"><div class="party-label">×ª×§×•×¤×”:</div><div class="party-value">${startDate} ×¢×“ ${expireDate}</div></div>
      </div>
    </div>
    <div class="contract-section">
      <div class="contract-section-title">×ª× ××™ ×”×”×¡×›×</div>
      <div class="contract-body">
        <div class="contract-clause">×”×§×•× ×” ××¡××™×š ××ª ×”××ª×•×•×š ×œ××ª×¨ ×¢×‘×•×¨×• × ×›×¡×™× ×”××ª××™××™× ×œ×“×¨×™×©×•×ª×™×•, ×œ× ×”×œ ××•"× ×‘×©××• ×•×œ×¡×™×™×¢ ×‘×”×©×œ××ª ×¢×¡×§×ª ×”×¨×›×™×©×”.</div>
        <div class="contract-clause">×‘×’×™×Ÿ ×›×œ ×¢×¡×§×” ×©×ª×•×©×œ× ×‘×ª×§×•×¤×” ×”× ×§×•×‘×” â€“ ×‘×™×Ÿ ×× ×‘×××¦×¢×•×ª ×”××ª×•×•×š ×•×‘×™×Ÿ ×× ×œ××• â€“ ×™×—×•×™×‘ ×”×§×•× ×” ×‘×“××™ ×ª×™×•×•×š ×©×œ <strong>${fee}</strong> ×××—×™×¨ ×”×¨×›×™×©×”, ×‘×ª×•×¡×¤×ª ××¢"×.</div>
        <div class="contract-clause">×”×§×•× ×” ××ª×—×™×™×‘ ×©×œ× ×œ×¨×›×•×© × ×›×¡×™× ×©×”×•×¦×’×• ×œ×• ×¢×œ ×™×“×™ ×”××ª×•×•×š ×“×¨×š ×’×•×¨× ××—×¨, ×œ×œ× ×”×¡×›××” ×›×ª×•×‘×”.</div>
        <div class="contract-clause">×“××™ ×”×ª×™×•×•×š ×™×©×•×œ××• ×‘××•×¢×“ ×—×ª×™××ª ×—×•×–×” ×”×¨×›×™×©×”.</div>
      </div>
    </div>
    <div class="contract-highlight">âš–ï¸ ×—×ª×™××” ×¢×œ ××¡××š ×–×” ××”×•×•×” ×”×¡×›××” ××œ××” ×•××—×™×™×‘×ª ×œ×›×œ ×”×ª× ××™×.</div>
    <div class="contract-footer">××¡××š ×–×” × ×—×ª× ×“×™×’×™×˜×œ×™×ª ×“×¨×š ××¢×¨×›×ª BrokerSign</div>`;
  } else {
    html=`<div class="contract-title">${typeNames[docType]||'××¡××š'}</div>
    <div class="contract-sub">×”×¡×›× ×–×” × ×¢×¨×š ×•× ×—×ª× ×‘×™×•× ${today}</div>
    <div class="contract-section">
      <div class="contract-section-title">×¤×¨×˜×™ ×”××¡××š</div>
      <div class="contract-parties">
        <div class="party-row"><div class="party-label">××ª×•×•×š:</div><div class="party-value">${brokerName}</div></div>
        <div class="party-row"><div class="party-label">×œ×§×•×—:</div><div class="party-value">${clientName}</div></div>
        <div class="party-row"><div class="party-label">×ª.×–.:</div><div class="party-value">${clientId}</div></div>
        <div class="party-row"><div class="party-label">× ×›×¡:</div><div class="party-value">${property}</div></div>
        <div class="party-row"><div class="party-label">×“××™ ×ª×™×•×•×š:</div><div class="party-value">${fee}</div></div>
        <div class="party-row"><div class="party-label">×ª×§×•×¤×”:</div><div class="party-value">${startDate} ×¢×“ ${expireDate}</div></div>
      </div>
    </div>
    <div class="contract-highlight">âš–ï¸ ×—×ª×™××” ×¢×œ ××¡××š ×–×” ××—×™×™×‘×ª ×œ×›×œ ×“×‘×¨.</div>
    <div class="contract-footer">××¡××š ×–×” × ×—×ª× ×“×™×’×™×˜×œ×™×ª ×“×¨×š ××¢×¨×›×ª BrokerSign</div>`;
  }
  document.getElementById('contract-content').innerHTML=html;
}

function showError(msg){
  document.getElementById('loading-screen').style.display='none';
  const el=document.getElementById('error-screen');
  el.style.display='block';
  if(msg)el.querySelector('p').textContent=msg;
}

function goToStep(n){
  document.querySelectorAll('.step').forEach(s=>s.classList.remove('active'));
  document.getElementById('step'+n).classList.add('active');
  if(n===2)setTimeout(initSig,100);
  window.scrollTo(0,0);
}

function initSig(){
  sigCanvas=document.getElementById('sig-canvas');
  const area=document.getElementById('sig-area');
  if(!area||!sigCanvas)return;
  sigCanvas.width=area.offsetWidth;sigCanvas.height=area.offsetHeight;
  sigCtx=sigCanvas.getContext('2d');
  sigCtx.strokeStyle='#0f0e0d';sigCtx.lineWidth=2.5;sigCtx.lineCap='round';sigCtx.lineJoin='round';
  const pos=e=>{const r=sigCanvas.getBoundingClientRect();return e.touches?{x:e.touches[0].clientX-r.left,y:e.touches[0].clientY-r.top}:{x:e.clientX-r.left,y:e.clientY-r.top};};
  sigCanvas.addEventListener('mousedown',e=>{e.preventDefault();signing=true;hasSig=true;document.getElementById('sig-ph').style.display='none';const p=pos(e);sigCtx.beginPath();sigCtx.moveTo(p.x,p.y);checkReady();});
  sigCanvas.addEventListener('mousemove',e=>{if(!signing)return;const p=pos(e);sigCtx.lineTo(p.x,p.y);sigCtx.stroke();});
  sigCanvas.addEventListener('mouseup',()=>signing=false);
  sigCanvas.addEventListener('touchstart',e=>{e.preventDefault();signing=true;hasSig=true;document.getElementById('sig-ph').style.display='none';const p=pos(e);sigCtx.beginPath();sigCtx.moveTo(p.x,p.y);checkReady();},{passive:false});
  sigCanvas.addEventListener('touchmove',e=>{e.preventDefault();if(!signing)return;const p=pos(e);sigCtx.lineTo(p.x,p.y);sigCtx.stroke();},{passive:false});
  sigCanvas.addEventListener('touchend',()=>signing=false);
}

function clearSig(){if(!sigCtx)return;sigCtx.clearRect(0,0,sigCanvas.width,sigCanvas.height);hasSig=false;document.getElementById('sig-ph').style.display='flex';checkReady();}
function checkReady(){const name=document.getElementById('signer-name').value.trim();const agreed=document.getElementById('agree-check').checked;document.getElementById('submit-btn').disabled=!(hasSig&&name&&agreed);}
document.addEventListener('input',checkReady);
document.addEventListener('change',checkReady);

async function submitSignature(){
  const name=document.getElementById('signer-name').value.trim();
  if(!hasSig||!name)return;
  const sigImage=sigCanvas.toDataURL('image/png');
  signedAt=new Date();signerNameFinal=name;
  document.getElementById('submit-btn').disabled=true;
  document.getElementById('submit-btn').textContent='×©×•××¨ ×—×ª×™××”...';
  const{error}=await sb.from('documents').update({status:'signed',signed_at:signedAt.toISOString(),signature_image:sigImage,signer_name_confirmed:name}).eq('id',docData.id);
  if(error){alert('×©×’×™××”. × ×¡×” ×©×•×‘.');document.getElementById('submit-btn').disabled=false;document.getElementById('submit-btn').textContent='âœ… ×× ×™ ×—×•×ª×/×ª';return;}
  const c=docData.content||{};
  const typeName=typeNames[docData.document_type]||'××¡××š';
  const dateStr=signedAt.toLocaleDateString('he-IL')+' '+signedAt.toLocaleTimeString('he-IL');
  const brokerName=brokerData?.full_name||'×”××ª×•×•×š';
  const clientName=c.client_name||name;
  const emailBody=buildEmailHTML(clientName,brokerName,typeName,dateStr,name,sigImage);
  if(c.client_email) await sendEmail(c.client_email,`âœ… ×”××¡××š × ×—×ª× â€“ ${typeName}`,emailBody);
  if(brokerData?.email) await sendEmail(brokerData.email,`âœ… ${clientName} ×—×ª×/×” ×¢×œ ${typeName}`,emailBody);
  document.getElementById('main-content').style.display='none';
  document.getElementById('success-screen').style.display='block';
  document.getElementById('success-name').textContent='×—×ª×/×”: '+name;
  document.getElementById('success-date').textContent='×ª××¨×™×š: '+dateStr;
  window.scrollTo(0,0);
}

function buildEmailHTML(clientName,brokerName,typeName,dateStr,signerName,sigImage){
  const c=docData.content||{};
  return `<div dir="rtl" style="font-family:Arial,sans-serif;max-width:640px;margin:0 auto;color:#0f0e0d">
    <div style="background:#1a1714;padding:24px;text-align:center;border-radius:12px 12px 0 0">
      <h1 style="color:#c9a84c;margin:0;font-size:24px">BrokerSign</h1>
      <p style="color:rgba(255,255,255,0.6);margin:6px 0 0;font-size:13px">××™×©×•×¨ ×—×ª×™××” ×“×™×’×™×˜×œ×™×ª</p>
    </div>
    <div style="background:#faf8f4;padding:32px;border:1px solid #ddd8cf;border-top:none;border-radius:0 0 12px 12px">
      <div style="background:#d1e7dd;border:1px solid #a3cfbb;border-radius:8px;padding:14px;text-align:center;margin-bottom:24px">
        <strong style="color:#0f5132;font-size:16px">âœ… ×”××¡××š × ×—×ª× ×‘×”×¦×œ×—×”!</strong>
      </div>
      <p style="font-size:15px;margin-bottom:20px"><strong>${clientName}</strong> ×—×ª×/×” ×¢×œ <strong>${typeName}</strong></p>
      <table style="width:100%;border-collapse:collapse;font-size:13px;margin-bottom:20px">
        <tr style="background:#fff"><td style="padding:10px;border:1px solid #ddd8cf;font-weight:600;width:35%">×¡×•×’ ××¡××š</td><td style="padding:10px;border:1px solid #ddd8cf">${typeName}</td></tr>
        <tr><td style="padding:10px;border:1px solid #ddd8cf;font-weight:600;background:#f7f4ef">×©× ×”×—×•×ª×</td><td style="padding:10px;border:1px solid #ddd8cf">${signerName}</td></tr>
        <tr style="background:#fff"><td style="padding:10px;border:1px solid #ddd8cf;font-weight:600">×ª.×–.</td><td style="padding:10px;border:1px solid #ddd8cf">${c.client_id||'â€”'}</td></tr>
        <tr><td style="padding:10px;border:1px solid #ddd8cf;font-weight:600;background:#f7f4ef">× ×›×¡</td><td style="padding:10px;border:1px solid #ddd8cf">${docData.notes||'â€”'}</td></tr>
        <tr style="background:#fff"><td style="padding:10px;border:1px solid #ddd8cf;font-weight:600">×“××™ ×ª×™×•×•×š</td><td style="padding:10px;border:1px solid #ddd8cf">${docData.fee_percent||'â€”'}</td></tr>
        <tr><td style="padding:10px;border:1px solid #ddd8cf;font-weight:600;background:#f7f4ef">×ª××¨×™×š ×—×ª×™××”</td><td style="padding:10px;border:1px solid #ddd8cf">${dateStr}</td></tr>
        <tr style="background:#fff"><td style="padding:10px;border:1px solid #ddd8cf;font-weight:600">××ª×•×•×š</td><td style="padding:10px;border:1px solid #ddd8cf">${brokerName}</td></tr>
      </table>
      <div style="text-align:center;margin-bottom:20px">
        <p style="font-size:12px;color:#6b6560;margin-bottom:8px">×—×ª×™××” ×“×™×’×™×˜×œ×™×ª:</p>
        <img src="${sigImage}" style="border:1px solid #ddd8cf;border-radius:8px;background:#fff;max-width:240px;height:80px;object-fit:contain">
      </div>
      <p style="font-size:12px;color:#6b6560;text-align:center;border-top:1px solid #ddd8cf;padding-top:16px">××¡××š ×–×” × ×—×ª× ×“×™×’×™×˜×œ×™×ª ×“×¨×š BrokerSign. ×”×—×ª×™××” ××—×™×™×‘×ª ×œ×›×œ ×“×‘×¨ ×•×¢× ×™×™×Ÿ.</p>
    </div>
  </div>`;
}

async function sendEmail(to,subject,html){
  try{await fetch('https://api.resend.com/emails',{method:'POST',headers:{'Authorization':'Bearer '+RESEND_KEY,'Content-Type':'application/json'},body:JSON.stringify({from:'BrokerSign <onboarding@resend.dev>',to:[to],subject,html})});}
  catch(e){console.log('Email error:',e);}
}

function downloadPDF(){
  const{jsPDF}=window.jspdf;
  const doc=new jsPDF({orientation:'portrait',unit:'mm',format:'a4'});
  const c=docData.content||{};
  const clientName=c.client_name||docData.title||'â€”';
  const today=signedAt?signedAt.toLocaleDateString('he-IL'):new Date().toLocaleDateString('he-IL');
  const dateTime=signedAt?signedAt.toLocaleDateString('he-IL')+' '+signedAt.toLocaleTimeString('he-IL'):today;
  const typeName=typeNames[docData.document_type]||'××¡××š';
  const brokerName=brokerData?.full_name||'â€”';
  const fee=docData.fee_percent||'â€”';
  const property=docData.notes||'â€”';
  const sd=docData.start_date?new Date(docData.start_date).toLocaleDateString('he-IL'):'â€”';
  const ed=docData.expire_date?new Date(docData.expire_date).toLocaleDateString('he-IL'):'â€”';

  doc.setFillColor(26,23,20);doc.rect(0,0,210,30,'F');
  doc.setTextColor(201,168,76);doc.setFontSize(18);doc.setFont('helvetica','bold');
  doc.text('BrokerSign',105,18,{align:'center'});
  doc.setTextColor(15,14,13);doc.setFontSize(16);
  doc.text(typeName,105,45,{align:'center'});
  doc.setFontSize(10);doc.setTextColor(107,101,96);
  doc.text('Signed: '+dateTime,105,52,{align:'center'});
  doc.setDrawColor(201,168,76);doc.setLineWidth(0.5);doc.line(20,56,190,56);

  doc.setTextColor(15,14,13);doc.setFontSize(11);doc.setFont('helvetica','bold');
  doc.text('PARTIES',20,65);
  doc.setFont('helvetica','normal');doc.setFontSize(10);
  doc.text('Broker: '+brokerName,20,73);
  doc.text('Client: '+clientName,20,80);
  doc.text('ID: '+(c.client_id||'â€”'),20,87);
  doc.text('Phone: '+(c.client_phone||'â€”'),110,80);
  doc.text('Email: '+(c.client_email||'â€”'),110,87);

  doc.setFont('helvetica','bold');doc.setFontSize(11);doc.text('PROPERTY & TERMS',20,100);
  doc.setFont('helvetica','normal');doc.setFontSize(10);
  doc.text('Property: '+property,20,108);
  doc.text('Fee: '+fee,20,115);
  doc.text('Period: '+sd+' to '+ed,20,122);

  doc.setFont('helvetica','bold');doc.setFontSize(11);doc.text('CONTRACT TERMS',20,135);
  doc.setFont('helvetica','normal');doc.setFontSize(9);
  const terms=['1. The owner exclusively authorizes the broker to market the property during the exclusivity period.','2. No other broker may be engaged without written consent during this period.','3. Brokerage fee of '+fee+' is due upon any transaction, whether or not facilitated by the broker.','4. The broker commits to best efforts in marketing, including advertising and negotiation.','5. This agreement is governed by the Israeli Real Estate Brokers Law, 1996.'];
  let y=143;
  terms.forEach(t=>{const lines=doc.splitTextToSize(t,170);doc.text(lines,20,y);y+=lines.length*5+2;});

  y+=6;doc.setDrawColor(201,168,76);doc.setLineWidth(0.5);doc.line(20,y,190,y);y+=10;
  doc.setFont('helvetica','bold');doc.setFontSize(12);doc.text('DIGITAL SIGNATURE',20,y);y+=8;
  doc.setFont('helvetica','normal');doc.setFontSize(10);
  doc.text('Signer name: '+signerNameFinal,20,y);
  doc.text('Date & Time: '+dateTime,20,y+7);
  doc.text('Document ID: '+docData.id,20,y+14);

  if(sigCanvas){
    const sigImg=sigCanvas.toDataURL('image/png');
    doc.addImage(sigImg,'PNG',120,y-5,70,28);
    doc.setDrawColor(180,180,180);doc.setLineWidth(0.3);doc.rect(120,y-5,70,28);
    doc.setFontSize(8);doc.setTextColor(150,150,150);doc.text('Digital Signature',155,y+26,{align:'center'});
  }

  doc.setFillColor(247,244,239);doc.rect(0,272,210,25,'F');
  doc.setTextColor(107,101,96);doc.setFontSize(8);
  doc.text('Signed digitally via BrokerSign | brokersign-rho.vercel.app',105,281,{align:'center'});
  doc.text('This digital signature is legally binding under Israeli law.',105,287,{align:'center'});

  doc.save(`BrokerSign_${typeName}_${clientName}_${today.replace(/\//g,'-')}.pdf`);
}

init();
</script>
</body>
</html>
