<!DOCTYPE html>

<html lang="he" dir="rtl">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>BrokerSign</title>
<link href="https://fonts.googleapis.com/css2?family=Heebo:wght@300;400;500;600;700;800;900&family=Playfair+Display:wght@700;900&display=swap" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<style>
:root {
  --ink: #0f0e0d;
  --paper: #f7f4ef;
  --warm: #faf8f4;
  --gold: #c9a84c;
  --gold-light: #e8d08a;
  --deep: #1a1714;
  --mid: #6b6560;
  --border: #ddd8cf;
  --success: #2d6a4f;
  --danger: #8b2020;
}
* { margin:0; padding:0; box-sizing:border-box; }
body { font-family:'Heebo',sans-serif; background:var(--paper); color:var(--ink); direction:rtl; min-height:100vh; }

/* AUTH SCREEN */
.auth-screen {
min-height:100vh;
display:flex;
align-items:center;
justify-content:center;
background: linear-gradient(135deg, var(â€“deep) 0%, #2d2520 100%);
padding:20px;
}
.auth-card {
background:var(â€“warm);
border-radius:20px;
padding:48px 40px;
width:100%;
max-width:420px;
box-shadow:0 32px 80px rgba(0,0,0,0.4);
}
.auth-logo { text-align:center; margin-bottom:32px; }
.auth-logo .brand { font-family:â€˜Playfair Displayâ€™,serif; font-size:32px; color:var(â€“gold); }
.auth-logo .sub { font-size:13px; color:var(â€“mid); margin-top:4px; }
.auth-tabs { display:flex; border-bottom:2px solid var(â€“border); margin-bottom:28px; }
.auth-tab {
flex:1; padding:10px; text-align:center; cursor:pointer;
font-size:14px; font-weight:600; color:var(â€“mid);
border-bottom:2px solid transparent; margin-bottom:-2px;
transition:all 0.2s;
}
.auth-tab.active { color:var(â€“gold); border-bottom-color:var(â€“gold); }
.form-group { margin-bottom:16px; }
.form-label { display:block; font-size:13px; font-weight:600; margin-bottom:6px; }
.form-input {
width:100%; padding:11px 14px;
border:1.5px solid var(â€“border); border-radius:8px;
font-family:â€˜Heeboâ€™,sans-serif; font-size:14px;
background:#fff; direction:rtl; transition:border-color 0.2s;
}
.form-input:focus { outline:none; border-color:var(â€“gold); }
.btn-auth {
width:100%; padding:13px;
background:var(â€“gold); color:var(â€“deep);
border:none; border-radius:8px;
font-family:â€˜Heeboâ€™,sans-serif; font-size:15px; font-weight:700;
cursor:pointer; transition:all 0.2s; margin-top:8px;
}
.btn-auth:hover { background:var(â€“gold-light); }
.auth-error { background:#fee; border:1px solid #fcc; border-radius:8px; padding:10px 14px; font-size:13px; color:var(â€“danger); margin-bottom:14px; display:none; }

/* APP */
.app { display:none; }
.app-layout { display:flex; min-height:100vh; }

/* SIDEBAR */
.sidebar {
width:240px; background:var(â€“deep); color:#fff;
display:flex; flex-direction:column;
position:fixed; height:100vh; right:0; z-index:100; overflow-y:auto;
}
.sidebar-logo { padding:28px 24px 20px; border-bottom:1px solid rgba(255,255,255,0.08); }
.sidebar-logo .brand { font-family:â€˜Playfair Displayâ€™,serif; font-size:22px; color:var(â€“gold); }
.sidebar-logo .sub { font-size:11px; color:rgba(255,255,255,0.4); margin-top:2px; font-weight:300; }
.sidebar-section { padding:18px 16px 8px; font-size:10px; letter-spacing:1.5px; text-transform:uppercase; color:rgba(255,255,255,0.3); font-weight:600; }
.nav-item {
display:flex; align-items:center; gap:10px;
padding:11px 20px; cursor:pointer; transition:all 0.2s;
font-size:14px; color:rgba(255,255,255,0.65);
border-right:3px solid transparent; margin:1px 0;
}
.nav-item:hover { background:rgba(255,255,255,0.06); color:#fff; }
.nav-item.active { background:rgba(201,168,76,0.12); color:var(â€“gold); border-right-color:var(â€“gold); }
.nav-item .icon { font-size:16px; width:20px; text-align:center; }
.sidebar-footer { margin-top:auto; padding:20px; border-top:1px solid rgba(255,255,255,0.08); }
.user-info { font-size:12px; color:rgba(255,255,255,0.5); margin-bottom:10px; }
.user-info strong { display:block; color:rgba(255,255,255,0.85); font-size:13px; }
.btn-logout {
width:100%; padding:8px; background:rgba(255,255,255,0.08);
color:rgba(255,255,255,0.6); border:none; border-radius:6px;
font-family:â€˜Heeboâ€™,sans-serif; font-size:12px; cursor:pointer;
transition:all 0.2s;
}
.btn-logout:hover { background:rgba(255,255,255,0.15); color:#fff; }

/* MAIN */
.main { margin-right:240px; flex:1; display:flex; flex-direction:column; }
.topbar {
background:var(â€“warm); border-bottom:1px solid var(â€“border);
padding:16px 32px; display:flex; align-items:center;
justify-content:space-between; position:sticky; top:0; z-index:50;
}
.topbar h1 { font-size:20px; font-weight:700; }
.topbar .breadcrumb { font-size:13px; color:var(â€“mid); margin-top:2px; }
.topbar-actions { display:flex; gap:10px; align-items:center; }
.btn {
padding:9px 20px; border-radius:6px;
font-family:â€˜Heeboâ€™,sans-serif; font-size:13px; font-weight:600;
cursor:pointer; border:none; transition:all 0.2s;
display:inline-flex; align-items:center; gap:6px;
}
.btn-primary { background:var(â€“gold); color:var(â€“deep); }
.btn-primary:hover { background:var(â€“gold-light); }
.btn-outline { background:transparent; border:1.5px solid var(â€“border); color:var(â€“ink); }
.btn-outline:hover { border-color:var(â€“gold); color:var(â€“gold); }
.btn-ghost { background:transparent; color:var(â€“mid); }
.btn-ghost:hover { color:var(â€“ink); background:rgba(0,0,0,0.05); }
.content { padding:28px 32px; flex:1; }

/* STATS */
.stats-row { display:grid; grid-template-columns:repeat(4,1fr); gap:16px; margin-bottom:28px; }
.stat-card {
background:var(â€“warm); border:1px solid var(â€“border);
border-radius:10px; padding:20px; transition:box-shadow 0.2s;
}
.stat-card:hover { box-shadow:0 4px 16px rgba(0,0,0,0.08); }
.stat-label { font-size:12px; color:var(â€“mid); font-weight:500; text-transform:uppercase; letter-spacing:0.5px; }
.stat-value { font-size:28px; font-weight:800; margin-top:6px; }
.stat-value.gold { color:var(â€“gold); }
.stat-sub { font-size:12px; color:var(â€“mid); margin-top:4px; }

/* CARD / TABLE */
.card { background:var(â€“warm); border:1px solid var(â€“border); border-radius:12px; overflow:hidden; }
.card-header { padding:18px 24px; border-bottom:1px solid var(â€“border); display:flex; align-items:center; justify-content:space-between; }
.card-header h2 { font-size:15px; font-weight:700; }
table { width:100%; border-collapse:collapse; }
th { padding:12px 20px; text-align:right; font-size:11px; letter-spacing:0.8px; text-transform:uppercase; color:var(â€“mid); font-weight:600; background:rgba(0,0,0,0.02); border-bottom:1px solid var(â€“border); }
td { padding:14px 20px; font-size:14px; border-bottom:1px solid rgba(0,0,0,0.04); vertical-align:middle; }
tr:last-child td { border-bottom:none; }
tr:hover td { background:rgba(201,168,76,0.04); }

.badge { display:inline-flex; align-items:center; gap:5px; padding:4px 10px; border-radius:20px; font-size:11px; font-weight:600; }
.badge-pending { background:#fff3cd; color:#856404; }
.badge-signed { background:#d1e7dd; color:#0f5132; }
.badge-expired { background:#f8d7da; color:#842029; }
.badge-draft { background:#e2e3e5; color:#41464b; }

.empty-state { text-align:center; padding:60px 20px; color:var(â€“mid); }
.empty-state .emoji { font-size:48px; margin-bottom:12px; }

/* MODAL */
.modal-overlay {
position:fixed; inset:0; background:rgba(15,14,13,0.65);
z-index:200; display:flex; align-items:center; justify-content:center;
backdrop-filter:blur(3px); opacity:0; pointer-events:none; transition:opacity 0.25s;
}
.modal-overlay.open { opacity:1; pointer-events:all; }
.modal {
background:var(â€“warm); border-radius:16px; width:560px;
max-width:95vw; max-height:90vh; overflow-y:auto;
box-shadow:0 24px 60px rgba(0,0,0,0.3);
transform:translateY(20px); transition:transform 0.25s;
}
.modal-overlay.open .modal { transform:translateY(0); }
.modal-header { padding:24px 28px 20px; border-bottom:1px solid var(â€“border); display:flex; align-items:center; justify-content:space-between; }
.modal-header h2 { font-size:18px; font-weight:800; }
.modal-body { padding:24px 28px; }
.modal-footer { padding:18px 28px; border-top:1px solid var(â€“border); display:flex; gap:10px; }
.form-row { display:grid; grid-template-columns:1fr 1fr; gap:14px; }
.form-select, .form-textarea {
width:100%; padding:10px 14px; border:1.5px solid var(â€“border);
border-radius:8px; font-family:â€˜Heeboâ€™,sans-serif; font-size:14px;
background:#fff; direction:rtl; transition:border-color 0.2s;
}
.form-select:focus, .form-textarea:focus { outline:none; border-color:var(â€“gold); }
.form-textarea { resize:vertical; min-height:80px; }

.doc-type-grid { display:grid; grid-template-columns:1fr 1fr; gap:10px; margin-top:6px; }
.doc-type-option {
border:1.5px solid var(â€“border); border-radius:8px; padding:12px 14px;
cursor:pointer; transition:all 0.2s; font-size:13px;
display:flex; align-items:center; gap:8px; background:#fff;
}
.doc-type-option:hover { border-color:var(â€“gold); }
.doc-type-option.selected { border-color:var(â€“gold); background:rgba(201,168,76,0.08); font-weight:600; }

.send-method-row { display:flex; gap:8px; }
.send-method-btn {
flex:1; padding:10px; border:1.5px solid var(â€“border);
border-radius:8px; cursor:pointer; text-align:center; font-size:12px;
transition:all 0.2s; background:#fff; font-family:â€˜Heeboâ€™,sans-serif; font-weight:500;
}
.send-method-btn:hover { border-color:var(â€“gold); }
.send-method-btn.selected { border-color:var(â€“gold); background:rgba(201,168,76,0.1); font-weight:700; }

.steps { display:flex; gap:0; border-bottom:1px solid var(â€“border); padding-bottom:0; margin-bottom:24px; }
.step { display:flex; align-items:center; gap:8px; padding:0 0 14px; margin-left:24px; font-size:13px; color:var(â€“mid); border-bottom:2px solid transparent; margin-bottom:-1px; }
.step.active { color:var(â€“gold); border-bottom-color:var(â€“gold); font-weight:700; }
.step.done { color:var(â€“success); }
.step-num { width:22px; height:22px; border-radius:50%; background:var(â€“border); display:flex; align-items:center; justify-content:center; font-size:11px; font-weight:700; flex-shrink:0; }
.step.active .step-num { background:var(â€“gold); color:var(â€“deep); }
.step.done .step-num { background:var(â€“success); color:#fff; }

.info-box { background:rgba(201,168,76,0.08); border:1px solid rgba(201,168,76,0.3); border-radius:8px; padding:12px 16px; font-size:13px; color:#7a5c00; display:flex; gap:8px; margin-bottom:16px; }

/* SIGNATURE PAD */
.sig-area {
border:2px dashed var(â€“border); border-radius:8px; background:#fff;
height:140px; display:flex; flex-direction:column; align-items:center;
justify-content:center; cursor:crosshair; position:relative; overflow:hidden; margin-bottom:8px;
}
.sig-area canvas { position:absolute; inset:0; }
.sig-placeholder { color:var(â€“mid); font-size:13px; pointer-events:none; z-index:1; }

/* TOAST */
.toast {
position:fixed; bottom:24px; left:24px; background:var(â€“deep); color:#fff;
padding:14px 20px; border-radius:10px; font-size:14px; font-weight:500;
box-shadow:0 8px 24px rgba(0,0,0,0.25); transform:translateY(80px); opacity:0;
transition:all 0.3s; z-index:500; display:flex; align-items:center; gap:10px; min-width:260px;
}
.toast.show { transform:translateY(0); opacity:1; }
.toast.success { border-right:4px solid #52b788; }
.toast.info { border-right:4px solid var(â€“gold); }

.loading-overlay {
position:fixed; inset:0; background:rgba(15,14,13,0.8);
display:flex; align-items:center; justify-content:center;
z-index:999; color:#fff; font-size:16px; gap:12px;
}
.spinner {
width:24px; height:24px; border:3px solid rgba(255,255,255,0.3);
border-top-color:#fff; border-radius:50%;
animation:spin 0.8s linear infinite;
}
@keyframes spin { to { transform:rotate(360deg); } }

.plan-badge { display:inline-flex; align-items:center; gap:4px; padding:3px 10px; border-radius:20px; font-size:11px; font-weight:700; }
.plan-free { background:#e2e3e5; color:#41464b; }
.plan-pro { background:rgba(201,168,76,0.2); color:#7a5c00; }
.plan-enterprise { background:#1a1714; color:var(â€“gold); }

.action-menu { position:relative; display:inline-block; }
.action-dropdown { position:absolute; left:0; top:100%; background:#fff; border:1px solid var(â€“border); border-radius:8px; box-shadow:0 8px 24px rgba(0,0,0,0.12); width:160px; z-index:50; display:none; overflow:hidden; margin-top:4px; }
.action-dropdown.open { display:block; }
.action-dropdown button { display:block; width:100%; text-align:right; padding:10px 14px; font-family:â€˜Heeboâ€™,sans-serif; font-size:13px; border:none; background:transparent; cursor:pointer; transition:background 0.15s; color:var(â€“ink); direction:rtl; }
.action-dropdown button:hover { background:var(â€“paper); }
.action-dropdown button.danger { color:var(â€“danger); }

@media (max-width:768px) {
.sidebar { display:none; }
.main { margin-right:0; }
.stats-row { grid-template-columns:1fr 1fr; }
.content { padding:16px; }
.topbar { padding:14px 16px; }
.form-row { grid-template-columns:1fr; }
}

.doc-preview { background:#fff; border:1px solid var(â€“border); border-radius:8px; padding:20px; font-size:13px; line-height:1.8; max-height:240px; overflow-y:auto; margin-bottom:16px; }
.doc-preview h3 { text-align:center; font-size:15px; font-weight:800; margin-bottom:12px; }
.field-highlight { background:rgba(201,168,76,0.15); padding:1px 5px; border-radius:3px; }
</style>

</head>
<body>

<!-- LOADING -->

<div class="loading-overlay" id="loading">
  <div class="spinner"></div>
  <span>×˜×•×¢×Ÿ...</span>
</div>

<!-- AUTH SCREEN -->

<div class="auth-screen" id="auth-screen" style="display:none">
  <div class="auth-card">
    <div class="auth-logo">
      <div class="brand">BrokerSign</div>
      <div class="sub">×¤×œ×˜×¤×•×¨××ª × ×™×”×•×œ × ×›×¡×™× ×•×—×ª×™××” ×“×™×’×™×˜×œ×™×ª</div>
    </div>
    <div class="auth-tabs">
      <div class="auth-tab active" onclick="switchAuthTab('login')">×”×ª×—×‘×¨×•×ª</div>
      <div class="auth-tab" onclick="switchAuthTab('register')">×”×¨×©××”</div>
    </div>
    <div id="auth-error" class="auth-error"></div>

```
<!-- LOGIN -->
<div id="login-form">
  <div class="form-group">
    <label class="form-label">××™××™×™×œ</label>
    <input class="form-input" id="login-email" type="email" placeholder="your@email.com">
  </div>
  <div class="form-group">
    <label class="form-label">×¡×™×¡××”</label>
    <input class="form-input" id="login-password" type="password" placeholder="â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢">
  </div>
  <button class="btn-auth" onclick="login()">×›× ×™×¡×” â†</button>
</div>

<!-- REGISTER -->
<div id="register-form" style="display:none">
  <div class="form-row">
    <div class="form-group">
      <label class="form-label">×©× ××œ× *</label>
      <input class="form-input" id="reg-name" placeholder="×™×©×¨××œ ×™×©×¨××œ×™">
    </div>
    <div class="form-group">
      <label class="form-label">×˜×œ×¤×•×Ÿ</label>
      <input class="form-input" id="reg-phone" placeholder="050-0000000">
    </div>
  </div>
  <div class="form-group">
    <label class="form-label">××™××™×™×œ *</label>
    <input class="form-input" id="reg-email" type="email" placeholder="your@email.com">
  </div>
  <div class="form-group">
    <label class="form-label">×¡×™×¡××” *</label>
    <input class="form-input" id="reg-password" type="password" placeholder="×œ×¤×—×•×ª 6 ×ª×•×•×™×">
  </div>
  <div class="form-group">
    <label class="form-label">×©× ×—×‘×¨×” / ××©×¨×“</label>
    <input class="form-input" id="reg-company" placeholder="××©×¨×“ ×ª×™×•×•×š X">
  </div>
  <button class="btn-auth" onclick="register()">×¦×•×¨ ×—×©×‘×•×Ÿ ×—×™× ××™ â†</button>
</div>
```

  </div>
</div>

<!-- APP -->

<div class="app" id="app">
  <div class="app-layout">
    <aside class="sidebar">
      <div class="sidebar-logo">
        <div class="brand">BrokerSign</div>
        <div class="sub">×¤×œ×˜×¤×•×¨××ª × ×™×”×•×œ × ×›×¡×™×</div>
      </div>
      <div class="sidebar-section">×¨××©×™</div>
      <div class="nav-item" onclick="setPage('dashboard',this)"><span class="icon">ğŸ“Š</span> ×œ×•×— ×‘×§×¨×”</div>
      <div class="sidebar-section">××¡××›×™×</div>
      <div class="nav-item active" onclick="setPage('signatures',this)"><span class="icon">âœï¸</span> ×—×ª×™××•×ª</div>
      <div class="sidebar-section">× ×™×”×•×œ</div>
      <div class="nav-item" onclick="setPage('properties',this)"><span class="icon">ğŸ </span> × ×›×¡×™×</div>
      <div class="nav-item" onclick="setPage('clients',this)"><span class="icon">ğŸ‘¥</span> ×œ×§×•×—×•×ª</div>
      <div class="nav-item" onclick="setPage('brokers',this)"><span class="icon">ğŸ¤</span> ×©×ª"×¤</div>
      <div class="sidebar-footer">
        <div class="user-info">
          <strong id="sidebar-name">×˜×•×¢×Ÿ...</strong>
          <span id="sidebar-email"></span>
          <span id="sidebar-plan" class="plan-badge plan-free" style="margin-top:6px">×—×™× ××™</span>
        </div>
        <button class="btn-logout" onclick="logout()">ğŸšª ×”×ª× ×ª×§</button>
      </div>
    </aside>

```
<div class="main">
  <div class="topbar">
    <div>
      <h1 id="page-title">×—×ª×™××•×ª ×“×™×’×™×˜×œ×™×•×ª</h1>
      <div class="breadcrumb" id="page-breadcrumb">BrokerSign â€º ×—×ª×™××•×ª</div>
    </div>
    <div class="topbar-actions">
      <button class="btn btn-primary" id="main-action-btn" onclick="openModal('newDoc')">âœï¸ ×©×œ×— ×œ×—×ª×™××”</button>
    </div>
  </div>

  <div class="content" id="page-content">
    <!-- SIGNATURES PAGE -->
    <div id="page-signatures">
      <div class="stats-row" id="stats-row">
        <div class="stat-card"><div class="stat-label">××¡××›×™× × ×©×œ×—×•</div><div class="stat-value" id="stat-total">0</div><div class="stat-sub">×¡×”"×›</div></div>
        <div class="stat-card"><div class="stat-label">×××ª×™× ×™×</div><div class="stat-value gold" id="stat-pending">0</div><div class="stat-sub">×œ×—×ª×™××”</div></div>
        <div class="stat-card"><div class="stat-label">× ×—×ª××•</div><div class="stat-value" style="color:var(--success)" id="stat-signed">0</div><div class="stat-sub">×”×•×©×œ××•</div></div>
        <div class="stat-card"><div class="stat-label">×¤×’ ×ª×•×§×£</div><div class="stat-value" style="color:var(--danger)" id="stat-expired">0</div><div class="stat-sub">×œ×—×™×“×•×©</div></div>
      </div>
      <div class="card">
        <div class="card-header">
          <h2>××¡××›×™× ×œ×—×ª×™××”</h2>
        </div>
        <div id="docs-container"></div>
      </div>
    </div>
  </div>
</div>
```

  </div>
</div>

<!-- MODAL: NEW DOCUMENT -->

<div class="modal-overlay" id="modal-newDoc">
  <div class="modal">
    <div class="modal-header">
      <h2>âœï¸ ×©×œ×™×—×ª ××¡××š ×œ×—×ª×™××”</h2>
      <button class="btn btn-ghost" onclick="closeModal('newDoc')">âœ•</button>
    </div>
    <div class="modal-body">
      <div class="steps">
        <div class="step active" id="s1"><div class="step-num">1</div> ×¤×¨×˜×™ ×œ×§×•×—</div>
        <div class="step" id="s2"><div class="step-num">2</div> ××¡××š</div>
        <div class="step" id="s3"><div class="step-num">3</div> ×©×œ×™×—×”</div>
      </div>
      <div id="step1">
        <div class="form-row">
          <div class="form-group"><label class="form-label">×©× ××œ× *</label><input class="form-input" id="f-name" placeholder="×™×©×¨××œ ×™×©×¨××œ×™"></div>
          <div class="form-group"><label class="form-label">×ª.×–.</label><input class="form-input" id="f-id" placeholder="012345678"></div>
        </div>
        <div class="form-row">
          <div class="form-group"><label class="form-label">×˜×œ×¤×•×Ÿ</label><input class="form-input" id="f-phone" placeholder="050-0000000"></div>
          <div class="form-group"><label class="form-label">××™××™×™×œ</label><input class="form-input" id="f-email" type="email" placeholder="client@email.com"></div>
        </div>
        <div class="form-group"><label class="form-label">×›×ª×•×‘×ª × ×›×¡</label><input class="form-input" id="f-address" placeholder="×¨×—×•×‘, ×¢×™×¨"></div>
      </div>
      <div id="step2" style="display:none">
        <div class="form-group">
          <label class="form-label">×¡×•×’ ××¡××š *</label>
          <div class="doc-type-grid">
            <div class="doc-type-option" onclick="selectDoc(this,'exclusivity')">ğŸ“‹ ×”×¡×›× ×‘×œ×¢×“×™×•×ª</div>
            <div class="doc-type-option" onclick="selectDoc(this,'management')">ğŸ¢ ×”×¡×›× × ×™×”×•×œ × ×›×¡</div>
            <div class="doc-type-option" onclick="selectDoc(this,'memorandum')">ğŸ“ ×–×™×›×¨×•×Ÿ ×“×‘×¨×™×</div>
            <div class="doc-type-option" onclick="selectDoc(this,'poa')">âš–ï¸ ×™×™×¤×•×™ ×›×•×—</div>
          </div>
        </div>
        <div class="form-row">
          <div class="form-group"><label class="form-label">×ª××¨×™×š ×ª×—×™×œ×”</label><input class="form-input" id="f-start" type="date"></div>
          <div class="form-group"><label class="form-label">×ª××¨×™×š ×¤×§×™×¢×”</label><input class="form-input" id="f-expire" type="date"></div>
        </div>
        <div class="form-group"><label class="form-label">×“××™ ×ª×™×•×•×š / ×¢××œ×”</label><input class="form-input" id="f-fee" placeholder='2% + ××¢"×'></div>
      </div>
      <div id="step3" style="display:none">
        <div class="doc-preview" id="doc-preview"></div>
        <div class="form-group">
          <label class="form-label">×©×™×˜×ª ×©×œ×™×—×”</label>
          <div class="send-method-row">
            <button class="send-method-btn selected" onclick="selSend(this,'whatsapp')">ğŸ“± WhatsApp</button>
            <button class="send-method-btn" onclick="selSend(this,'email')">ğŸ“§ ××™×™×œ</button>
            <button class="send-method-btn" onclick="selSend(this,'sms')">ğŸ’¬ SMS</button>
          </div>
        </div>
        <div class="info-box">â° ×”×œ×§×•×— ×™×§×‘×œ ×§×™×©×•×¨ ×œ×—×ª×™××” ×“×™×’×™×˜×œ×™×ª. ×”×—×ª×™××” ×ª×™×©××¨ ×¢× ×—×•×ª××ª ×–××Ÿ.</div>
      </div>
    </div>
    <div class="modal-footer">
      <button class="btn btn-primary" id="next-btn" onclick="nextStep()">×”××©×š â†</button>
      <button class="btn btn-outline" id="back-btn" onclick="prevStep()" style="display:none">â†’ ×—×–×•×¨</button>
      <button class="btn btn-ghost" onclick="closeModal('newDoc')">×‘×™×˜×•×œ</button>
    </div>
  </div>
</div>

<!-- MODAL: SIGN -->

<div class="modal-overlay" id="modal-sign">
  <div class="modal">
    <div class="modal-header">
      <h2 id="sign-modal-title">×—×ª×™××” ×¢×œ ××¡××š</h2>
      <button class="btn btn-ghost" onclick="closeModal('sign')">âœ•</button>
    </div>
    <div class="modal-body">
      <div class="info-box">ğŸ“‹ ×§×¨×/×™ ××ª ×”××¡××š ×‘×¢×™×•×Ÿ ×œ×¤× ×™ ×”×—×ª×™××”</div>
      <div class="doc-preview" id="sign-doc-preview"></div>
      <div class="form-group">
        <label class="form-label">×—×ª×™××”</label>
        <div class="sig-area" id="sig-area">
          <canvas id="sig-canvas"></canvas>
          <span class="sig-placeholder" id="sig-ph">×—×ª×•×/×™ ×›××Ÿ</span>
        </div>
        <button class="btn btn-ghost" style="font-size:12px;padding:5px 12px;margin-top:6px" onclick="clearSig()">ğŸ—‘ × ×§×”</button>
      </div>
      <div class="form-group">
        <label class="form-label">×©× ××œ× ×œ××™×©×•×¨ *</label>
        <input class="form-input" id="confirm-name" placeholder="×”×›× ×¡ ×©××š ×”××œ×">
      </div>
    </div>
    <div class="modal-footer">
      <button class="btn btn-primary" onclick="submitSign()">âœ… ×× ×™ ×××©×¨/×ª ×•×—×•×ª×/×ª</button>
      <button class="btn btn-ghost" onclick="closeModal('sign')">×‘×™×˜×•×œ</button>
    </div>
  </div>
</div>

<div class="toast" id="toast"><span id="toast-msg"></span></div>

<script>
// ===== SUPABASE INIT =====
const SUPABASE_URL = 'https://lrelmsldoqkifmxionnk.supabase.co';
const SUPABASE_KEY = 'sb_publishable_Z9haU6VnacVW52WoW_Qtsw_bZp9Rs9_';
const { createClient } = supabase;
const sb = createClient(SUPABASE_URL, SUPABASE_KEY);

let currentUser = null;
let currentBroker = null;
let allDocs = [];
let currentStep = 1;
let selectedDocType = '';
let selectedSend = 'whatsapp';
let currentSignDocId = null;
let sigCtx, sigCanvas, signing = false, hasSig = false;

// ===== INIT =====
async function init() {
  const { data: { session } } = await sb.auth.getSession();
  if (session) {
    currentUser = session.user;
    await loadBroker();
    showApp();
  } else {
    showAuth();
  }
  document.getElementById('loading').style.display = 'none';
}

async function loadBroker() {
  const { data } = await sb.from('brokers').select('*').eq('auth_id', currentUser.id).single();
  if (data) {
    currentBroker = data;
    document.getElementById('sidebar-name').textContent = data.full_name;
    document.getElementById('sidebar-email').textContent = data.email;
    const planEl = document.getElementById('sidebar-plan');
    planEl.textContent = data.plan === 'free' ? '×—×™× ××™' : data.plan === 'pro' ? 'Pro' : 'Enterprise';
    planEl.className = `plan-badge plan-${data.plan}`;
  }
}

function showApp() {
  document.getElementById('auth-screen').style.display = 'none';
  document.getElementById('app').style.display = 'block';
  loadDocuments();
}

function showAuth() {
  document.getElementById('auth-screen').style.display = 'flex';
  document.getElementById('app').style.display = 'none';
}

// ===== AUTH =====
function switchAuthTab(tab) {
  document.querySelectorAll('.auth-tab').forEach((t,i) => t.classList.toggle('active', (i===0&&tab==='login')||(i===1&&tab==='register')));
  document.getElementById('login-form').style.display = tab==='login'?'block':'none';
  document.getElementById('register-form').style.display = tab==='register'?'block':'none';
  document.getElementById('auth-error').style.display = 'none';
}

async function login() {
  const email = document.getElementById('login-email').value.trim();
  const password = document.getElementById('login-password').value;
  if (!email || !password) { showAuthError('× × ×œ××œ× ××™××™×™×œ ×•×¡×™×¡××”'); return; }
  showLoading();
  const { data, error } = await sb.auth.signInWithPassword({ email, password });
  hideLoading();
  if (error) { showAuthError('××™××™×™×œ ××• ×¡×™×¡××” ×©×’×•×™×™×'); return; }
  currentUser = data.user;
  await loadBroker();
  showApp();
}

async function register() {
  const name = document.getElementById('reg-name').value.trim();
  const email = document.getElementById('reg-email').value.trim();
  const password = document.getElementById('reg-password').value;
  const phone = document.getElementById('reg-phone').value.trim();
  const company = document.getElementById('reg-company').value.trim();
  if (!name || !email || !password) { showAuthError('× × ×œ××œ× ×©×, ××™××™×™×œ ×•×¡×™×¡××”'); return; }
  if (password.length < 6) { showAuthError('×”×¡×™×¡××” ×—×™×™×‘×ª ×œ×”×™×•×ª ×œ×¤×—×•×ª 6 ×ª×•×•×™×'); return; }
  showLoading();
  const { data, error } = await sb.auth.signUp({ email, password });
  if (error) { hideLoading(); showAuthError(error.message); return; }
  // Create broker profile
  await sb.from('brokers').insert({ auth_id: data.user.id, full_name: name, email, phone, company_name: company, plan: 'free' });
  hideLoading();
  currentUser = data.user;
  await loadBroker();
  showApp();
  showToast('ğŸ‰ ×‘×¨×•×š ×”×‘× ×œ-BrokerSign!', 'success');
}

async function logout() {
  await sb.auth.signOut();
  currentUser = null; currentBroker = null;
  showAuth();
}

function showAuthError(msg) {
  const el = document.getElementById('auth-error');
  el.textContent = msg; el.style.display = 'block';
}

// ===== DOCUMENTS =====
async function loadDocuments() {
  if (!currentBroker) return;
  const { data } = await sb.from('documents').select('*').eq('broker_id', currentBroker.id).order('created_at', { ascending: false });
  allDocs = data || [];
  renderDocs();
  updateStats();
}

function updateStats() {
  document.getElementById('stat-total').textContent = allDocs.length;
  document.getElementById('stat-pending').textContent = allDocs.filter(d=>d.status==='pending').length;
  document.getElementById('stat-signed').textContent = allDocs.filter(d=>d.status==='signed').length;
  document.getElementById('stat-expired').textContent = allDocs.filter(d=>d.status==='expired').length;
}

function renderDocs() {
  const container = document.getElementById('docs-container');
  if (allDocs.length === 0) {
    container.innerHTML = `<div class="empty-state"><div class="emoji">ğŸ“­</div><p>××™×Ÿ ××¡××›×™× ×¢×“×™×™×Ÿ</p><p style="font-size:13px;margin-top:8px">×œ×—×¥ ×¢×œ "×©×œ×— ×œ×—×ª×™××”" ×œ×”×ª×—×™×œ</p></div>`;
    return;
  }
  const typeMap = { exclusivity:'×”×¡×›× ×‘×œ×¢×“×™×•×ª', management:'×”×¡×›× × ×™×”×•×œ × ×›×¡', memorandum:'×–×™×›×¨×•×Ÿ ×“×‘×¨×™×', poa:'×™×™×¤×•×™ ×›×•×—' };
  container.innerHTML = `<table><thead><tr><th>××¡××š</th><th>×œ×§×•×—</th><th>× ×›×¡</th><th>× ×©×œ×—</th><th>×¡×˜×˜×•×¡</th><th>×¤×¢×•×œ×•×ª</th></tr></thead><tbody>
    ${allDocs.map(d => `<tr>
      <td><strong>${typeMap[d.document_type]||d.document_type}</strong></td>
      <td>${d.title}</td>
      <td style="font-size:12px;color:var(--mid)">${d.notes||'â€”'}</td>
      <td style="font-size:12px">${new Date(d.created_at).toLocaleDateString('he-IL')}</td>
      <td>${badgeHTML(d.status)}</td>
      <td>
        <div class="action-menu">
          <button class="btn btn-ghost" style="padding:5px 10px;font-size:13px" onclick="toggleMenu(event,'am-${d.id}')">â‹¯</button>
          <div class="action-dropdown" id="am-${d.id}">
            ${d.status==='pending'?`<button onclick="openSignView('${d.id}')">ğŸ‘ ×ª×¦×•×’×ª ×—×ª×™××”</button>`:''}
            <button onclick="remindDoc('${d.id}')">ğŸ“² ×ª×–×›×•×¨×ª</button>
            <button class="danger" onclick="deleteDoc('${d.id}')">ğŸ—‘ ××—×§</button>
          </div>
        </div>
      </td>
    </tr>`).join('')}
  </tbody></table>`;
}

function badgeHTML(status) {
  const m = { pending:['badge-pending','â³ ×××ª×™×Ÿ'], signed:['badge-signed','âœ… × ×—×ª×'], expired:['badge-expired','âŒ ×¤×’ ×ª×•×§×£'], draft:['badge-draft','ğŸ“ ×˜×™×•×˜×”'] };
  const [c,l] = m[status]||['badge-draft','?'];
  return `<span class="badge ${c}">${l}</span>`;
}

// ===== SEND DOCUMENT =====
async function sendDocument() {
  const name = document.getElementById('f-name').value.trim();
  const title = name;
  const address = document.getElementById('f-address').value.trim();
  const expire = document.getElementById('f-expire').value;
  showLoading();
  const expireDate = expire ? new Date(expire) : new Date(Date.now() + 90*24*60*60*1000);
  const { error } = await sb.from('documents').insert({
    broker_id: currentBroker.id,
    document_type: selectedDocType,
    title: title,
    status: 'pending',
    send_method: selectedSend,
    notes: address,
    fee_percent: document.getElementById('f-fee').value,
    start_date: document.getElementById('f-start').value || null,
    expire_date: expire || null,
    token_expires_at: expireDate.toISOString(),
    content: {
      client_name: name,
      client_id: document.getElementById('f-id').value,
      client_phone: document.getElementById('f-phone').value,
      client_email: document.getElementById('f-email').value,
    }
  });
  hideLoading();
  if (error) { showToast('×©×’×™××” ×‘×©××™×¨×”: ' + error.message, 'info'); return; }
  closeModal('newDoc');
  await loadDocuments();
  const methodLabel = { whatsapp:'ğŸ“± WhatsApp', email:'ğŸ“§ ××™×™×œ', sms:'ğŸ’¬ SMS' }[selectedSend];
  showToast(`âœ… ×”××¡××š × ×©×œ×— ×œ-${name} ×“×¨×š ${methodLabel}`, 'success');
}

// ===== STEPS =====
function nextStep() {
  if (currentStep === 1) {
    if (!document.getElementById('f-name').value.trim()) { showToast('âš ï¸ × × ×œ×”×›× ×™×¡ ×©× ×œ×§×•×—','info'); return; }
    goStep(2);
  } else if (currentStep === 2) {
    if (!selectedDocType) { showToast('âš ï¸ × × ×œ×‘×—×•×¨ ×¡×•×’ ××¡××š','info'); return; }
    buildPreview();
    goStep(3);
    document.getElementById('next-btn').textContent = 'ğŸ“¤ ×©×œ×— ×œ×—×ª×™××”';
  } else {
    sendDocument();
  }
}
function prevStep() {
  if (currentStep === 2) goStep(1);
  else if (currentStep === 3) { goStep(2); document.getElementById('next-btn').textContent = '×”××©×š â†'; }
}
function goStep(n) {
  document.getElementById('step'+currentStep).style.display='none';
  document.getElementById('s'+currentStep).classList.remove('active');
  if(n>currentStep) document.getElementById('s'+currentStep).classList.add('done');
  currentStep=n;
  document.getElementById('step'+n).style.display='block';
  document.getElementById('s'+n).classList.add('active');
  document.getElementById('back-btn').style.display=n>1?'inline-flex':'none';
}
function resetSteps() {
  currentStep=1; selectedDocType='';
  ['f-name','f-id','f-phone','f-email','f-address','f-fee'].forEach(id=>{const el=document.getElementById(id);if(el)el.value='';});
  document.querySelectorAll('.doc-type-option').forEach(o=>o.classList.remove('selected'));
  document.querySelectorAll('.send-method-btn').forEach((b,i)=>b.classList.toggle('selected',i===0));
  selectedSend='whatsapp';
  for(let i=1;i<=3;i++){
    const el=document.getElementById('step'+i); if(el) el.style.display=i===1?'block':'none';
    const s=document.getElementById('s'+i); if(s){s.classList.remove('active','done');if(i===1)s.classList.add('active');}
  }
  document.getElementById('next-btn').textContent='×”××©×š â†';
  document.getElementById('back-btn').style.display='none';
}
function selectDoc(el, type) {
  document.querySelectorAll('.doc-type-option').forEach(o=>o.classList.remove('selected'));
  el.classList.add('selected'); selectedDocType=type;
}
function selSend(el, method) {
  document.querySelectorAll('.send-method-btn').forEach(b=>b.classList.remove('selected'));
  el.classList.add('selected'); selectedSend=method;
}
function buildPreview() {
  const name=document.getElementById('f-name').value;
  const addr=document.getElementById('f-address').value;
  const fee=document.getElementById('f-fee').value||'2%';
  const typeNames={exclusivity:'×”×¡×›× ×‘×œ×¢×“×™×•×ª',management:'×”×¡×›× × ×™×”×•×œ × ×›×¡',memorandum:'×–×™×›×¨×•×Ÿ ×“×‘×¨×™×',poa:'×™×™×¤×•×™ ×›×•×—'};
  document.getElementById('doc-preview').innerHTML=`
    <h3>${typeNames[selectedDocType]}</h3>
    <p>×œ×§×•×—: <span class="field-highlight">${name}</span></p>
    <p>× ×›×¡: <span class="field-highlight">${addr||'×œ× ×¦×•×™×Ÿ'}</span></p>
    <p>×“××™ ×ª×™×•×•×š: <span class="field-highlight">${fee}</span></p>
    <p>×ª××¨×™×š: <span class="field-highlight">${new Date().toLocaleDateString('he-IL')}</span></p>
    <p style="margin-top:12px;font-size:12px;color:var(--mid)">×”××¡××š ×™×™×©×œ×— ×¢× ×§×™×©×•×¨ ×œ×—×ª×™××” ×“×™×’×™×˜×œ×™×ª</p>`;
}

// ===== SIGN =====
function openSignView(docId) {
  const doc = allDocs.find(d=>d.id===docId);
  if (!doc) return;
  const typeNames={exclusivity:'×”×¡×›× ×‘×œ×¢×“×™×•×ª',management:'×”×¡×›× × ×™×”×•×œ × ×›×¡',memorandum:'×–×™×›×¨×•×Ÿ ×“×‘×¨×™×',poa:'×™×™×¤×•×™ ×›×•×—'};
  document.getElementById('sign-modal-title').textContent = `âœï¸ ${typeNames[doc.document_type]}`;
  document.getElementById('sign-doc-preview').innerHTML = `
    <h3>${typeNames[doc.document_type]}</h3>
    <p>×œ×§×•×—: <span class="field-highlight">${doc.title}</span></p>
    <p>× ×›×¡: <span class="field-highlight">${doc.notes||'â€”'}</span></p>
    <p>×“××™ ×ª×™×•×•×š: <span class="field-highlight">${doc.fee_percent||'â€”'}</span></p>`;
  currentSignDocId = docId;
  openModal('sign');
  setTimeout(initSig, 100);
}
function initSig() {
  sigCanvas=document.getElementById('sig-canvas');
  const area=document.getElementById('sig-area');
  sigCanvas.width=area.offsetWidth; sigCanvas.height=area.offsetHeight;
  sigCtx=sigCanvas.getContext('2d');
  sigCtx.strokeStyle='#0f0e0d'; sigCtx.lineWidth=2.5; sigCtx.lineCap='round';
  const pos=e=>{const r=sigCanvas.getBoundingClientRect();return e.touches?{x:e.touches[0].clientX-r.left,y:e.touches[0].clientY-r.top}:{x:e.clientX-r.left,y:e.clientY-r.top};};
  sigCanvas.onmousedown=sigCanvas.ontouchstart=e=>{e.preventDefault();signing=true;hasSig=true;document.getElementById('sig-ph').style.display='none';const p=pos(e);sigCtx.beginPath();sigCtx.moveTo(p.x,p.y);};
  sigCanvas.onmousemove=sigCanvas.ontouchmove=e=>{e.preventDefault();if(!signing)return;const p=pos(e);sigCtx.lineTo(p.x,p.y);sigCtx.stroke();};
  sigCanvas.onmouseup=sigCanvas.ontouchend=()=>{signing=false;};
}
function clearSig() {
  if(!sigCtx)return;
  sigCtx.clearRect(0,0,sigCanvas.width,sigCanvas.height);
  hasSig=false; document.getElementById('sig-ph').style.display='';
}
async function submitSign() {
  const name=document.getElementById('confirm-name').value.trim();
  if(!hasSig){showToast('âš ï¸ × × ×œ×—×ª×•×','info');return;}
  if(!name){showToast('âš ï¸ × × ×œ×”×›× ×™×¡ ×©×','info');return;}
  const sigImage=sigCanvas.toDataURL();
  showLoading();
  const {error}=await sb.from('documents').update({
    status:'signed', signed_at:new Date().toISOString(),
    signature_image:sigImage, signer_name_confirmed:name
  }).eq('id',currentSignDocId);
  hideLoading();
  if(error){showToast('×©×’×™××”: '+error.message,'info');return;}
  closeModal('sign');
  await loadDocuments();
  showToast(`âœ… ${name} ×—×ª×/×” ×‘×”×¦×œ×—×”!`,'success');
}

// ===== ACTIONS =====
function remindDoc(id) { showToast('ğŸ“² ×ª×–×›×•×¨×ª × ×©×œ×—×”','success'); }
async function deleteDoc(id) {
  if(!confirm('×œ××—×•×§ ××ª ×”××¡××š?'))return;
  await sb.from('documents').delete().eq('id',id);
  await loadDocuments();
  showToast('ğŸ—‘ ×”××¡××š × ××—×§','info');
}
function toggleMenu(e,id) {
  e.stopPropagation();
  document.querySelectorAll('.action-dropdown').forEach(m=>{if(m.id!==id)m.classList.remove('open');});
  document.getElementById(id).classList.toggle('open');
}
document.addEventListener('click',()=>document.querySelectorAll('.action-dropdown').forEach(m=>m.classList.remove('open')));

// ===== MODAL =====
function openModal(id) { document.getElementById('modal-'+id).classList.add('open'); document.body.style.overflow='hidden'; if(id==='newDoc')resetSteps(); }
function closeModal(id) { document.getElementById('modal-'+id).classList.remove('open'); document.body.style.overflow=''; }

// ===== PAGE NAV =====
function setPage(page, el) {
  document.querySelectorAll('.nav-item').forEach(n=>n.classList.remove('active'));
  if(el)el.classList.add('active');
  const titles={dashboard:'×œ×•×— ×‘×§×¨×”',signatures:'×—×ª×™××•×ª ×“×™×’×™×˜×œ×™×•×ª',properties:'× ×™×”×•×œ × ×›×¡×™×',clients:'× ×™×”×•×œ ×œ×§×•×—×•×ª',brokers:'×©×™×ª×•×¤×™ ×¤×¢×•×œ×”'};
  document.getElementById('page-title').textContent=titles[page]||page;
  document.getElementById('page-breadcrumb').textContent=`BrokerSign â€º ${titles[page]||page}`;
  if(page==='signatures'){
    document.getElementById('page-signatures').style.display='block';
    document.getElementById('main-action-btn').style.display='';
    const cs=document.getElementById('coming-soon');if(cs)cs.remove();
  } else {
    document.getElementById('page-signatures').style.display='none';
    document.getElementById('main-action-btn').style.display='none';
    let cs=document.getElementById('coming-soon');
    if(!cs){cs=document.createElement('div');cs.id='coming-soon';document.getElementById('page-content').appendChild(cs);}
    cs.innerHTML=`<div class="empty-state" style="padding:80px 20px"><div class="emoji">ğŸš§</div><p style="font-size:18px;font-weight:700;margin-bottom:8px">${titles[page]}</p><p>×‘×¤×™×ª×•×— â€“ ×™×”×™×” ×–××™×Ÿ ×‘×§×¨×•×‘</p></div>`;
  }
}

// ===== UTILS =====
function showToast(msg,type='success'){const t=document.getElementById('toast');document.getElementById('toast-msg').textContent=msg;t.className='toast show '+type;setTimeout(()=>t.classList.remove('show'),3500);}
function showLoading(){document.getElementById('loading').style.display='flex';}
function hideLoading(){document.getElementById('loading').style.display='none';}

// ===== START =====
init();
</script>

</body>
</html>
